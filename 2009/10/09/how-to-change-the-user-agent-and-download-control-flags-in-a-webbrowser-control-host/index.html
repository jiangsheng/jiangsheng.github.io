<!doctype html><html><head><meta charset="UTF-8"<title>How to change the user agent and download control flags in a webbrowser control host</head><body>User vnetvvv <a href="http://topic.csdn.net/u/20090929/13/1f3966e2-dd1b-43ac-b6ee-f300e69413d3.html">wants to know</a> how to change the user agent string in a <a class="zem_slink" title="Visual Basic" rel="homepage" href="http://msdn.microsoft.com/en-us/vbasic/default.aspx">VB6</a> webbrowser control. The <a class="zem_slink" title="Knowledge base" rel="wikipedia" href="http://en.wikipedia.org/wiki/Knowledge_base">knowledge base</a> article <a href="http://support.microsoft.com/kb/183412">PRB: WebBrowser Control Clients Share Global Settings</a> provides the necessary code for changing the user agent of the webbrowser control when the webbrowser ask for it. But how to have the webbrowser control ask for the user agent?

Well the webbrowser control is an <a class="zem_slink" title="ActiveX" rel="wikipedia" href="http://en.wikipedia.org/wiki/ActiveX">ActiveX</a>, so it implements <a href="http://msdn.microsoft.com/en-us/library/ms690175(VS.85).aspx">IOleControl::OnAmbientPropertyChange</a>. The <a href="http://msdn.microsoft.com/en-us/library/aa753622(VS.85).aspx">host can call the method</a> to notify the webbrowser control about the property change after the browser window is created. The list of ambient properties can be found in the <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=AE22E7A9-611F-4112-8B17-0980412D07A5&amp;displaylang=en">walkall sample</a>, the most useful ones are DISPID_AMBIENT_USERMODE (which VB6 supports), DISPID_AMBIENT_DLCONTROL and DISPID_AMBIENT_USERAGENT. The documentation of other ambient properties can be found in the <a href="http://msdn.microsoft.com/en-us/library/tc7644wx(v=VS.80).aspx">documentation of CComControlBase’s GetAmbient Property Methods</a>

Note the knowledge base article <a href="http://support.microsoft.com/kb/183412">PRB: WebBrowser Control Clients Share Global Settings</a> also says DISPID_AMBIENT_USERAGENT cannot be used to alter the user agent string in DOM or when the navigation is from code. Changing the user agent string in registry, of course, can change the behavior but will also have global effect.

Another way to change the user agent is to go directly into the networking layer of webbrowser control and change the user agent process-wide. Since most of the time per-page browser setting isn’t necessary this can also be used in custom browsers. The WinInet function <a href="http://msdn.microsoft.com/en-us/library/ms775125(VS.85).aspx">UrlMkSetSessionOption</a> has a flag URLMON_OPTION_USERAGENT that can be used to change the user agent, However it only updates DOM/Javascript and ignore the WinInet stack so other WinInet client won’t be affected, until you call UrlMkSetSessionOption with URLMON_OPTION_USERAGENTREFRESH. This is better for VB6 and .Net programmers since it does not involve <a href="http://www.mvps.org/emorcillo/en/code/vb6/index.shtml">declaring a lot of OLE interfaces</a>.

You can get the user agent from <a class="zem_slink" title="Document Object Model" rel="wikipedia" href="http://en.wikipedia.org/wiki/Document_Object_Model">the DOM</a> (<a href="http://msdn.microsoft.com/en-us/library/aa752116(VS.85).aspx">document</a>.<a href="http://msdn.microsoft.com/en-us/library/aa752599(VS.85).aspx">parentWindow</a>.<a href="http://msdn.microsoft.com/en-us/library/aa741467(v=VS.85).aspx">navigator</a>.<a href="http://msdn.microsoft.com/en-us/library/aa703729(v=VS.85).aspx">userAgent</a>).</body></html>