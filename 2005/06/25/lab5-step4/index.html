<!doctype html><html><head><meta charset="UTF-8"<title>Lab5 Step4</head><body><div id="msgcns!1BE894DEAF296E0A!191" class="bvMsg"><p>;=====================================================================<br />; DrawLine.asm - help routine to draw table lines<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/24/05<br />;=====================================================================</p> <p> INCLUDE lab5.inc<br /> .Code <br />DrawTableLine  PROC   USES eax ecx esi,  <br /> _TableWidth : DWORD, <br /> beginChar : BYTE, <br /> textBuffer:PTR BYTE,<br /> textLen :DWORD,<br /> fillChar:BYTE,<br /> endChar:BYTE<br /> LOCAL printtextlen : DWORD, totalTextLen :DWORD<br /> mov  eax,_TableWidth<br /> sub  eax,2<br /> mov  totalTextLen,eax   ;totalTextLen=_TableWidth-2<br /> .IF(totalTextLen&gt;0)<br />  ;beginChar, the left border<br />  mov   al,beginChar<br />  call  WriteChar<br />  <br />  ;cut the text if it is too long <br />  ;printtextlen=min(_TableWidth-2,textlen);<br />  mov   eax,textLen<br />  .IF(eax&gt;totalTextLen)<br />   mov eax,totalTextLen<br />   mov printtextlen,eax ;overflow<br />  .ELSE<br />   mov printtextlen,eax<br />  .ENDIF<br />  mov   ecx, printtextlen<br />  <br />  ; print the text part<br />  mov  esi,textBuffer<br />DrawTableLinePrintText:<br />  ;if no text left,jump to fill the line<br />  jcxz DrawTableLineFillLine<br />  mov  al,byte ptr [esi] <br />  call  WriteChar<br />  inc  esi<br />  loop DrawTableLinePrintText<br />  <br />DrawTableLineFillLine:<br />  ;fill the rest of table line<br />  ;will _TableWidth-2-printtextlen fillchars<br />  mov  ecx,totalTextLen<br />  sub  ecx,printtextlen<br />  mov  al,fillChar<br />DrawTableLineFillLineLoop:<br />  ;if no text left,jump to end the line<br />  jcxz DrawTableLineFillEndLine<br />  call WriteChar<br />  loop DrawTableLineFillLineLoop<br />DrawTableLineFillEndLine:<br />  mov  al,endChar<br />  call WriteChar<br />  call Crlf<br /> .ENDIF<br /> ret<br />DrawTableLine ENDP</p> <p> END;</p> <p>=====================================================================<br />; drawwrap.asm - help routine to draw table lines <br />; wrap to seperate lines if the text is too long, or delimiters were found in the text<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/24/05<br />;=====================================================================<br /> INCLUDE lab5.inc<br /> .Code<br />DrawTableLineWithWrap PROC USES eax edx esi edi,<br /> _TableWidth : DWORD, <br /> beginChar : BYTE, <br /> textBuffer: PTR BYTE,<br /> textLen :DWORD,<br /> fillChar:BYTE,<br /> endChar:BYTE,<br /> _Delimiter:BYTE<br /> LOCAL EndOfBuffer:PTR BYTE,  ; stop point of a buffer;textBuffer+textLen-1<br /> EndOfLineWrap:DWORD,    ; stop point of a line;_TableWidth -3<br /> curlinebase:PTR BYTE ,    ; pointer to the beginning of the current line<br /> curlineLen:DWORD,    ; length of the current line<br /> bTerminate:BYTE,    ; stop scanning<br /> bDelimiter:BYTE     ; include the current char in printing or not<br /> <br /> ;edi=esi=textBuffer;<br /> ;while(!bTerminate)<br /> ;&#123;<br /> ; if(edi==EndOfBuffer)&#123;bDelimiter=(_Delimiter==[edi];bTerminate=TRUE;&#125;<br /> ; else if([edi]=='')&#123;bDelimiter=TRUE;bTerminate=TRUE;&#125;<br /> ; else if([edi]==_Delimiter)<br /> ; &#123;<br /> ;  if(edi==curlinebase)&#123;edi++; curlinebase=edi;continue;&#125;//skip leading delimiters<br /> ;  else bDelimiter=TRUE;<br /> ; &#125;  <br /> ; else if(edi==curlinebase+_TableWidth -3) /*wrap*/&#123;bDelimiter=FALSE;&#125;<br /> ; else &#123;edi++; continue;&#125;<br /> ; DrawTableLine(_TableWidth ,MLBORDER,curlinebase,bDelimiter?edi-curlinebase:edi-curlinebase+1,FILLSPACE,MRBORDER);<br /> ; edi++;<br /> ; curlinebase=edi;<br /> ;&#125;<br /> mov   esi,textBuffer<br /> mov   edi,esi<br /> mov   eax,esi<br /> add   eax,textLen<br /> sub   eax,1<br /> mov   EndOfBuffer,eax<br /> mov   eax,_TableWidth <br /> sub   eax,3<br /> mov   EndOfLineWrap,eax<br /> mov   bTerminate,0<br /> mov   bDelimiter,0<br /> mov   curlinebase,esi<br /> .WHILE(bTerminate==0)<br />  mov eax,curlinebase<br />  add eax,EndOfLineWrap<br />  mov dl,byte ptr [edi]<br />  .IF(edi==EndOfBuffer)<br />   mov bTerminate,1<br />   .IF(dl==_Delimiter)<br />    mov bDelimiter,1<br />   .ELSE<br />    mov bDelimiter,0<br />   .ENDIF<br />  .ELSEIF(dl==0)<br />   mov bDelimiter,1<br />   mov bTerminate,1<br />  .ELSEIF(dl==_Delimiter)<br />   mov bDelimiter,1<br />  .ELSEIF(edi==eax)<br />   mov bDelimiter,0<br />  .ELSE<br />   inc edi<br />   .CONTINUE <br />  .ENDIF<br />  mov eax,edi<br />  sub eax,curlinebase<br />  .IF(bDelimiter==0)<br />   inc eax<br />  .ENDIF<br />  mov curlineLen,eax<br />  invoke DrawTableLine, _TableWidth,beginChar,curlinebase,curlineLen,fillChar,endChar<br />  inc edi<br />  mov curlinebase,edi   <br /> .ENDW<br /> ret<br />DrawTableLineWithWrap ENDP<br />END;</p> <p>=====================================================================<br />; lab5.asm - build a program that displays the Fibonacci numbers for a user defined input upper bound<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/21/05<br />;<br />;=====================================================================<br /> <br /> <br /> INCLUDE lab5.inc<br /> <br />    ;costants</p> <p><br /> .Data<br /> menuSelection     BYTE 0<br /> menustring      BYTE &quot;Menu| |Press [I] to Display program instructions|Press [N] to enter an integer number (0 - 20)|Press [F] - Display the first N Fibonacci numbers on the console|Press [X] - Quit the program&quot;,0<br /> menustringLen     DWORD $-menustring<br /> menuDelimiter     BYTE &quot;|&quot;<br /> menuPromptstring    BYTE &quot;Enter your selection(upper case or lower case)[I/N/F/X]:&quot;,0<br /> instructionString    BYTE &quot;This program displays the Fibonacci numbers for a user defined input upper bound(up to 20)|Type N to input the number, and type F to display results.&quot;,0<br /> instructionStringLen   DWORD $-instructionString <br /> numberPromptstring    BYTE &quot;Enter a upper bound (0-20) and press ENTER:&quot;,0<br /> invalidNumberPromptstring  BYTE &quot;only numbers from 0 to 20 are allowed&quot;,0<br /> ExitPromptstring    BYTE &quot;Exiting...&quot;,0<br /> invalidSelectionPromptstring BYTE &quot;Invalid selection. the selection must be one of I/N/F/X&quot;,0<br /> ShowFibPromptString    BYTE &quot;The requested Fibonacci numbers are:&quot;,0<br /> ExitFlag      BYTE SHOWMENU_CONTINUE<br /> isNumberEntered     BYTE 0<br /> number       SDWORD ?<br /> PUBLIC  menustring<br /> PUBLIC  menuDelimiter<br /> PUBLIC  menustringLen<br /> PUBLIC menuPromptstring<br /> PUBLIC ShowFibPromptString <br /> .CODE<br /> </p> <p><br />;invoke WriteFile,hOutPut,lpszText,sl,ADDR bWritten,NULL<br />main  PROC<br />   .REPEAT<br />    invoke ShowMenu,offset menuSelection<br />    mov  ExitFlag,al<br />    ;toupper(menuSelection)<br />    .IF(menuSelection&gt;'Z')<br />     mov al,menuSelection<br />     sub al,32<br />     mov menuSelection,al<br />    .ENDIF<br />    .IF(menuSelection=='I')<br />     call Clrscr <br />     invoke DrawTableLine,TABLEWIDTH,ULCORNER,0,0,HBAR,URCORNER<br />     invoke  DrawTableLineWithWrap,TABLEWIDTH, VBAR,OFFSET instructionString,instructionStringLen,BLACKSPACE,VBAR,menuDelimiter<br />     invoke DrawTableLine,TABLEWIDTH,LLCORNER,0,0,HBAR,LRCORNER<br />     call Crlf<br />    .ELSEIF(menuSelection=='N')<br />     call Crlf<br />     mov isNumberEntered,0<br />     .REPEAT <br />ReadNumber:<br />      call Crlf <br />      mov  edx,offset numberPromptstring<br />      call WriteString<br />      call ReadInt<br />      jno  ReadNumberSuccess<br />      call Crlf <br />      mov  edx,OFFSET invalidNumberPromptstring <br />      call WriteString<br />      call Crlf <br />      jmp  ReadNumber   ;go input again<br />ReadNumberSuccess:  ;validate number<br />      <br />      .IF(eax&gt;20)<br />       mov isNumberEntered,0<br />      .ELSEIF(eax&lt;0)<br />       mov isNumberEntered,0<br />      .ELSE<br />       mov isNumberEntered,1<br />       mov  number,eax   ;store good value<br />      .ENDIF<br />      <br />      .IF(isNumberEntered==0)<br />       mov  edx,OFFSET invalidNumberPromptstring <br />       call WriteString<br />       call Crlf <br />       .CONTINUE<br />      .ENDIF<br />     .UNTIL(isNumberEntered)<br />    .ELSEIF(menuSelection=='F')<br />     invoke ShowFibonaccinumbers,number<br />    .ELSEIF(menuSelection=='X')<br />     call Crlf<br />     call Crlf <br />     mov  edx,OFFSET ExitPromptstring<br />     call WriteString<br />     call Crlf <br />    .ELSE<br />     call Crlf <br />     call Crlf<br />     mov  edx,OFFSET invalidSelectionPromptstring<br />     call WriteString<br />     call Crlf <br />    .ENDIF<br />   .UNTIL(ExitFlag==SHOWMENU_EXIT)<br />   exit<br />main  ENDP<br />   END  main;<br />=====================================================================<br />; lab5.inc - build a program that displays the Fibonacci numbers for a user defined input upper bound<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/24/05<br />;=====================================================================</p> <p> .386<br /> option casemap:none</p> <p> ; -----------------------------------------------------------------<br /> ; include files that have MASM format prototypes for function calls<br /> ; -----------------------------------------------------------------<br /> INCLUDE Irvine32.inc<br /> ; ------------------------------------------------<br /> ; Library files that have definitions for function<br /> ; exports and tested reliable prebuilt code.<br /> ; ------------------------------------------------<br /> includelib gdi32.lib<br /> includelib user32.lib<br /> includelib kernel32.lib<br /> includelib Irvine32.lib<br /> ;constants<br /> CR EQU 0Dh<br /> LF EQU 0Ah<br /> TABLEWIDTH EQU  79<br /> HBAR        EQU  196<br /> VBAR        EQU  179<br /> ULCORNER    EQU  218<br /> URCORNER    EQU  191<br /> MLBORDER EQU  195<br /> MRBORDER EQU  180<br /> LLCORNER    EQU  192<br /> LRCORNER    EQU  217<br /> BLACKSPACE EQU  32<br /> SHOWMENU_EXIT equ 1<br /> SHOWMENU_CONTINUE equ 0 <br /> LAB5DEBUG EQU  1<br /> <br /> DrawTableLine  PROTO,_TableWidth : DWORD,<br />  beginChar : BYTE, <br />  textBuffer: PTR BYTE,<br />  textLen :DWORD, <br />  fillChar:BYTE, <br />  endChar:BYTE<br /> <br /> DrawTableLineWithWrap PROTO, _TableWidth : DWORD, <br />  beginChar : BYTE, <br />  textBuffer: PTR BYTE,<br />  textLen :DWORD,<br />  fillChar:BYTE,<br />  endChar:BYTE,<br />  _Delimiter:BYTE<br /> ShowMenu PROTO, pcharTyped: PTR BYTE <br /> ShowFibonaccinumbers PROTO, boundary:SDWORD</p> <p>#=====================================================================<br /># lab5 - build a program that displays the Fibonacci numbers for a user defined input upper bound<br /># Author: Sheng_Jiang<br /># Course: COSC 2425<br /># Date: 6/21/05<br />#=====================================================================<br />PROJECT = Lab5<br />NAME = Sheng_Jiang<br />Date = 6/21/05<br />ROOTDRIVE  = C<br />VERSION   = V1</p> <p>SRCS   = <br />    $(PROJECT).asm<br />    drawline.asm<br />    drawwrap.asm<br />    showmenu.asm<br />    makefile </p> <p>MASM32   = $(ROOTDRIVE):/masm32<br />ML    = $(MASM32)/bin/ml<br />LINK   = $(MASM32)/bin/link<br />Zip    = H:/mydoc/Tools/Bin/zip<br />DEBUG   = c:/masm32/debug/windbg<br />Irvine32  = H:/mydoc/MyProjct/COSC2425/Lib32</p> <p>MLFLAGS   = /I. /I $(MASM32)include /I $(MASM32)macros /I $(Irvine32) /Zi /Zd /Zf /c /Fl /coff /Cp<br />LINKFLAGS  = /subsystem:console /libpath:$(MASM32)lib /libpath:$(Irvine32) /debug <br />DEBUGFLAGS  = -g -G -QY -logo $(PROJECT).log -QSY -sdce -WF $(PROJECT).WEW</p> <p>all: $(PROJECT).exe</p> <p>$(PROJECT).obj: $(PROJECT).asm DrawLine.obj DrawWrap.obj showmenu.obj showFib.obj<br /> $(ML) $(MLFLAGS) $(PROJECT).asm</p> <p>$(PROJECT).exe: $(PROJECT).obj <br /> $(LINK) $(LINKFLAGS) /out:$(PROJECT).exe  $(PROJECT).obj DrawLine.obj DrawWrap.obj showmenu.obj showFib.obj<br /> <br />DrawLine.obj: DrawLine.asm<br /> $(ML) $(MLFLAGS) DrawLine.asm<br /> <br />DrawWrap.obj: DrawWrap.asm DrawLine.obj<br /> $(ML) $(MLFLAGS) DrawWrap.asm<br /> <br />ShowMenu.obj: ShowMenu.asm DrawWrap.obj<br /> $(ML) $(MLFLAGS) ShowMenu.asm<br />showFib.obj: showFib.asm<br /> $(ML) $(MLFLAGS) showFib.asm</p> <p>clean:<br /> del $(PROJECT).exe *.obj *.lst *.map *.pdb *.ilk *.log</p> <p>zip: clean<br />  del $(NAME)_$(PROJECT)_$(VERSION).zip<br />  $(Zip) $(NAME)_$(PROJECT)_$(VERSION).zip $(SRCS)<br />debug: $(PROJECT).exe<br />  $(DEBUG) $(DEBUGFLAGS) $(PROJECT).exe</p> <p><br />;=====================================================================<br />; ShowFib.asm - help routine to draw table lines, and get user input<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/24/05<br />;=====================================================================<br /> INCLUDE lab5.inc<br /> .Data<br /> extern ShowFibPromptString:BYTE<br /> .Code <br /> <br />Fibonacci PROC USES ecx edx, x:SDWORD<br /> .IF(x&lt;2)<br />  mov eax,x<br /> .ELSE<br />  mov edx,0<br />  mov ecx,x<br />  dec ecx<br />  invoke Fibonacci,ecx<br />  mov edx,eax<br />  dec ecx<br />  invoke Fibonacci,ecx<br />  add edx,eax<br />  mov eax,edx  <br /> .ENDIF<br /> ret<br />Fibonacci ENDP<br />ShowFibonaccinumbers Proc USES ecx edx, boundary :SDWORD<br />   call Crlf<br />   mov edx,OFFSET ShowFibPromptString<br />   call Crlf<br />   mov ecx,0<br />   .WHILE(ecx&lt;=boundary)<br />    invoke Fibonacci,ecx<br />    call WriteInt<br />    mov al,BLACKSPACE<br />    call WriteChar <br />    inc ecx<br />   .ENDW</p> <p>   ret<br />ShowFibonaccinumbers EndP<br /> END <br />;=====================================================================<br />; ShowMenu.asm - help routine to draw table lines, and get user input<br />; Author: Sheng_Jiang<br />; Course: COSC 2425<br />; Date: 6/24/05<br />;=====================================================================<br /> INCLUDE lab5.inc<br /> .Data<br /> extern menustring  :BYTE <br /> extern menustringLen :DWORD <br /> extern menuDelimiter :BYTE <br /> extern menuPromptstring :BYTE<br /> .Code <br /> <br />ShowMenu Proc USES edx, pcharTyped: PTR BYTE <br />   call Crlf<br />   invoke DrawTableLine,TABLEWIDTH,ULCORNER,0,0,HBAR,URCORNER<br />   invoke  DrawTableLineWithWrap,TABLEWIDTH, VBAR,OFFSET menustring,menustringLen,BLACKSPACE,VBAR,menuDelimiter<br />   invoke DrawTableLine,TABLEWIDTH,LLCORNER,0,0,HBAR,LRCORNER<br />   call Crlf<br />   mov edx,offset menuPromptstring<br />   call WriteString<br />   call ReadChar<br />   mov edx,dword ptr [pcharTyped]<br />   mov byte ptr [edx],al<br />   .IF(al=='X')<br />    mov al,SHOWMENU_EXIT<br />   .ELSEIF(al=='x')<br />    mov al,SHOWMENU_EXIT<br />   .ELSE<br />    mov al,SHOWMENU_CONTINUE<br />   .ENDIF<br />   ret<br />ShowMenu EndP<br /> END</p></div></body></html>